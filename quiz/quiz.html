<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .quiz-option { transition: background-color 0.3s, border-color 0.3s; }
        .correct { background-color: #d1fae5 !important; border-color: #10b981 !important; color: #047857; }
        .incorrect { background-color: #fee2e2 !important; border-color: #ef4444 !important; color: #b91c1c; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-lg p-6 md:p-8">
        <header id="quiz-header" class="mb-8 text-center">
            <h1 id="quiz-title" class="text-3xl md:text-4xl font-bold text-gray-900">Loading Quiz...</h1>
            <p id="quiz-subtitle" class="text-gray-500 mt-2"></p>
        </header>

        <div id="quiz-container" class="space-y-8"></div>

        <div id="results-container" class="text-center mt-10 hidden">
            <h2 id="score-text" class="text-2xl font-bold mb-4"></h2>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button id="redo-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Redo Quiz</button>
                <a href="../index.html" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg">Back to Main Page</a>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase services and the quizzes database
        import { auth, db } from '../firebase-init.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        import { quizzes } from './quizzes.js';

        // --- 1. GET THE QUIZ ID FROM THE URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const quizId = urlParams.get('id'); // e.g., "c2-error-detection"

        // --- 2. FIND THE QUIZ DATA ---
        const quizData = quizzes[quizId];
        const questions = quizData ? quizData.questions : [];

        // --- Get page elements ---
        const quizContainer = document.getElementById('quiz-container');
        const resultsContainer = document.getElementById('results-container');
        const scoreText = document.getElementById('score-text');
        const redoBtn = document.getElementById('redo-btn');
        const quizTitle = document.getElementById('quiz-title');
        const quizSubtitle = document.getElementById('quiz-subtitle');
        
        let score = 0;
        let questionsAnswered = 0;
        let currentUser = null;

        // --- 3. SAVE HIGH SCORE (This function is updated for Firestore) ---
        function saveHighScore(currentScore) {
            if (!currentUser) return;

            const userScoresRef = doc(db, 'scores', currentUser.uid);
            const totalQuestions = questions.length;

            // The new data object now includes the 'lastCompleted' date
            const scoreData = {
                score: currentScore,
                total: totalQuestions,
                lastCompleted: new Date().toISOString() // Saves the current date and time
            };

            // Check against the existing high score before saving
            userScoresRef.get().then((docSnap) => {
                const existingData = docSnap.exists() ? docSnap.data()[quizId] : { score: 0 };
                if (currentScore >= existingData.score) {
                    setDoc(userScoresRef, {
                        [quizId]: scoreData
                    }, { merge: true });
                }
            });
        }
        
        // --- 4. POPULATE & BUILD THE QUIZ ---
        function initializePage() {
            if (!quizData) {
                quizTitle.textContent = "Quiz Not Found";
                quizSubtitle.textContent = "Please check the ID and try again.";
                return;
            }

            // Set the page title and headers
            document.title = quizData.title;
            quizTitle.textContent = quizData.title;
            quizSubtitle.textContent = quizData.subtitle;
            buildQuiz();
        }

        // --- The rest of your quiz logic (shuffle, selectAnswer, etc.) ---
        function buildQuiz() {
            quizContainer.innerHTML = '';
            const shuffledQuestions = shuffleArray([...questions]);
            shuffledQuestions.forEach((currentQuestion, questionNumber) => {
                const questionDiv = document.createElement('div');
                const questionTitleEl = document.createElement('h2');
                questionTitleEl.className = 'text-lg font-semibold mb-4';
                questionTitleEl.innerText = `${questionNumber + 1}. ${currentQuestion.question}`;
                questionDiv.appendChild(questionTitleEl);
                
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'grid grid-cols-1 sm:grid-cols-2 gap-3';
                const shuffledOptions = shuffleArray([...currentQuestion.options]);
                shuffledOptions.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'quiz-option w-full p-3 text-left border-2 border-gray-300 rounded-lg hover:bg-gray-100';
                    button.innerText = option;
                    button.onclick = () => selectAnswer(button, option, currentQuestion, optionsDiv);
                    optionsDiv.appendChild(button);
                });
                
                questionDiv.appendChild(optionsDiv);
                quizContainer.appendChild(questionDiv);
            });
        }

        function selectAnswer(selectedButton, selectedOption, currentQuestion, optionsContainer) {
            const correctAnswer = currentQuestion.answer;
            optionsContainer.querySelectorAll('.quiz-option').forEach(button => {
                button.disabled = true;
                if (button.innerText === correctAnswer) button.classList.add('correct');
            });

            if (selectedOption === correctAnswer) {
                score++;
            } else {
                selectedButton.classList.add('incorrect');
            }
            questionsAnswered++;
            if (questionsAnswered === questions.length) showResults();
        }

        function showResults() {
            saveHighScore(score);
            scoreText.innerText = `You scored ${score} out of ${questions.length}!`;
            resultsContainer.classList.remove('hidden');
        }

        function redoQuiz() {
            score = 0;
            questionsAnswered = 0;
            resultsContainer.classList.add('hidden');
            buildQuiz();
            quizContainer.scrollIntoView({ behavior: 'smooth' });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- 5. INITIALIZE THE PAGE ON LOAD ---
        redoBtn.addEventListener('click', redoQuiz);

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user; // Set the current user
                initializePage(); // Load the quiz content
            } else {
                // Not logged in, redirect to login page
                window.location.href = 'login.html';
            }
        });
    </script>
</body>
</html>
